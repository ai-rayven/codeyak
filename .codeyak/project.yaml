# Generated Code Review Guidelines
# Auto-generated by CodeYak from git history analysis
# Review and customize before using

guidelines:
  - label: sanitize-llm-responses
    description: |
      Treat LLM outputs as untrusted: validate structured fields and human-readable reasoning before acting. Filter out entries where the reasoning explicitly states no violation (e.g., "no violation", "correctly follows"), and improve prompts to reduce false positives. Add unit/parsing checks and a clear mapping from rationale text to decision to avoid publishing spurious comments.
    # Confidence: high
    # Reasoning: Commit 1920dd74 introduced detection of false positives from LLM reasoning and filtered them out before publishing comments; the change also updated the system prompt. This indicates LLM outputs caused incorrect behavior.

  - label: preserve-trace-context-on-early-return
    description: |
      Ensure telemetry/trace propagation and associated attributes are set before any early return or short-circuit. If you must short-circuit (e.g., when skipping work because an existing summary exists), run that logic inside the active propagate/trace context so user_id and tags are associated with the trace.
    # Confidence: high
    # Reasoning: Commit 2fbd3815 moved the skip-check inside the propagate_context so user_id was attached to traces when reviews were skipped, showing missing context propagation on returns.

  - label: lazy-init-config
    description: |
      Do not perform configuration validation or expensive initialization at import time. Use a lazy getter/factory (e.g., get_settings()) so validation happens when the app is starting (or when settings are first needed), and so errors can be handled or surfaced more clearly during startup instead of on import.
    # Confidence: high
    # Reasoning: Commit 1ca6397c changed to lazy settings initialization to defer validation and improve error handling; an import-time validated settings caused problems.

  - label: normalize-config-values
    description: |
      Normalize and validate configuration values coming from environment or user input (e.g., URLs, tokens). Trim trailing slashes from endpoints, validate required formats, and canonicalize values at adapter construction to avoid downstream auth or parsing errors.
    # Confidence: high
    # Reasoning: Commit 1ff3f8e3 stripped a trailing slash from the Azure endpoint to solve auth errors, showing the need to normalize external inputs.

  - label: explicit-dependency-injection-and-validate-third-party-usage
    description: |
      Pass external dependencies and config explicitly into constructors (avoid importing global settings inside libraries). Verify third-party API usage (constructor args and method names) matches the library docs and add small integration/unit tests exercising adapter initialization and calls to catch signature or API changes early.
    # Confidence: high
    # Reasoning: Several commits (dc961b80, d77a0915) fixed constructor parameters and library patch method names for the Azure adapter and replaced hard-coded settings with constructor args, indicating brittle integration code and reliance on globals.
  - label: respect-diff-lines-for-comments
    description: |
      Only post inline VCS comments for lines that exist in the current diff; define and document a clear fallback policy (skip, aggregate, or post a general comment) and prefer skipping invalid inline comments to avoid noisy or misleading feedback.
      

  - label: validate-models-and-types
    description: |
      Keep data models and type annotations accurate and validated: run static type checks and schema validation in tests, remove or update obsolete fields, and use explicit nullable types (e.g., Optional[T]) to prevent runtime validation errors.
      

  - label: use-appropriate-metrics-for-decisions
    description: |
      Track both raw (original) and post-filtered metrics and base user-visible decisions on the metric that matches the intent; clearly distinguish which metric drove a decision to avoid misleading outputs.
      
  - label: map-provider-errors-to-domain-exceptions
    description: |
      Translate provider-specific or adapter exceptions into well-defined domain-level exceptions (e.g., LineNotInDiffError, VCSCommentError) and handle them explicitly at call sites so higher-level logic can decide whether to skip, retry, fallback, or surface an error. Document and unit-test the mapping so behavior is consistent across adapters.
      

  - label: parse-and-deduplicate-existing-comments
    description: |
      When deduplicating review findings, parse existing review/MR comments to extract structured metadata (guideline IDs, file paths, line numbers) and deduplicate against both original and filtered sets so you reliably detect duplicates and report accurate counts. Preserve original counts for reporting and make the parser resilient to legacy comment formats.
      
